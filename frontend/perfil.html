<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu Perfil - Durmsgeo</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  
  <style>
    :root {
      --primary: #05df34;       
      --primary-hover: #04b32a;
      --bg-body: #0f172a;       
      --text-main: #f1f5f9;     
      --text-muted: #94a3b8;    
      --border: rgba(255,255,255,0.08);
      --card-bg: #1e293b;
      --input-bg: #0f172a;
      --instagram-gradient: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; outline: none; }
    
    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 40px;
    }

    nav {
      width: 100%;
      max-width: 800px;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .nav-left { display: flex; align-items: center; gap: 15px; }

    .btn-back {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: 0.2s;
      display: flex; align-items: center; gap: 6px;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .btn-back:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
    
    .btn-admin {
      background: rgba(255, 215, 0, 0.1);
      color: #ffd700;
      border: 1px solid rgba(255, 215, 0, 0.3);
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
      display: none;
      align-items: center; gap: 6px;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .btn-admin:hover { background: rgba(255, 215, 0, 0.2); transform: translateY(-2px); }

    .btn-logout {
      background: rgba(255, 50, 50, 0.1);
      color: #ff6b6b;
      border: 1px solid rgba(255, 50, 50, 0.2);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
      display: flex; align-items: center; gap: 6px;
      font-size: 0.9rem;
    }
    .btn-logout:hover { background: rgba(255, 50, 50, 0.2); }

    .profile-card {
      background: var(--card-bg);
      width: 90%;
      max-width: 500px;
      border-radius: 24px;
      padding: 30px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }

    .bg-gradient {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 100px;
      background: linear-gradient(180deg, rgba(5, 223, 52, 0.15) 0%, rgba(30, 41, 59, 0) 100%);
      z-index: 0;
    }

    .profile-header {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .avatar-container {
      width: 110px; height: 110px;
      border-radius: 50%;
      padding: 4px;
      background: linear-gradient(135deg, var(--primary), #00600f);
      margin-bottom: 16px;
      position: relative;
    }
    .avatar {
      width: 100%; height: 100%;
      border-radius: 50%;
      object-fit: cover;
      background: #0f172a;
      border: 4px solid var(--card-bg);
    }
    .edit-btn {
      position: absolute;
      bottom: 0; right: 0;
      background: var(--text-main);
      color: var(--bg-body);
      border-radius: 50%;
      width: 32px; height: 32px;
      display: flex; justify-content: center; align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      border: none;
      transition: transform 0.2s;
    }

    .user-name { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    
    .badge-title {
        font-size: 0.7rem;
        background: rgba(5, 223, 52, 0.1);
        color: var(--primary);
        padding: 4px 8px;
        border-radius: 20px;
        border: 1px solid rgba(5, 223, 52, 0.3);
        vertical-align: middle;
        font-weight: 600;
        text-transform: uppercase;
    }

    .instagram-link {
        font-size: 0.9rem;
        text-decoration: none;
        margin-bottom: 10px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background: var(--instagram-gradient);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 600;
        transition: opacity 0.2s;
    }
    .instagram-link i { font-size: 1.1rem; color: #dc2743; } 

    .user-bio { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px; line-height: 1.4; max-width: 80%; }
    
    .member-since { font-size: 0.75rem; color: var(--text-muted); opacity: 0.6; margin-bottom: 24px; display: flex; align-items: center; gap: 5px;}

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      width: 100%;
      margin-bottom: 24px;
    }
    .stat-box {
      background: rgba(15, 23, 42, 0.5);
      padding: 16px;
      border-radius: 16px;
      text-align: center;
      border: 1px solid var(--border);
    }
    .stat-value { font-size: 1.25rem; font-weight: 700; color: var(--primary); }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

    .xp-container {
      width: 100%;
      margin-top: 10px;
    }
    .xp-info {
      display: flex; justify-content: space-between;
      font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px;
    }
    .progress-bg {
      width: 100%;
      height: 12px;
      background: #0f172a;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #6aff8d);
      width: 0%;
      border-radius: 20px;
      transition: width 1s ease-in-out;
      box-shadow: 0 0 10px rgba(5, 223, 52, 0.4);
    }

    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
      z-index: 100;
      display: none; justify-content: center; align-items: center;
      opacity: 0; transition: opacity 0.3s;
    }
    .modal-overlay.open { display: flex; opacity: 1; }
    
    .modal-box {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 24px;
      width: 90%; max-width: 400px;
      border: 1px solid var(--border);
      transform: scale(0.9); transition: transform 0.3s;
    }
    .modal-overlay.open .modal-box { transform: scale(1); }

    .modal-title { margin-bottom: 20px; font-size: 1.2rem; }
    
    .input-group { margin-bottom: 15px; text-align: left; }
    .input-group label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; }
    
    .modal-input {
      width: 100%; padding: 12px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: white;
    }

    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
    .btn-save { flex: 1; background: var(--primary); color: #001a05; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }
    .btn-cancel { flex: 1; background: transparent; color: var(--text-muted); padding: 12px; border-radius: 12px; border: 1px solid var(--border); cursor: pointer; }

    .loading-overlay {
      position: absolute; inset: 0;
      background: var(--card-bg);
      display: flex; justify-content: center; align-items: center;
      z-index: 10;
    }
    .spinner { animation: spin 1s linear infinite; font-size: 2rem; color: var(--primary); }
    @keyframes spin { 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <nav>
    <div class="nav-left">
      <a href="index.html" class="btn-back">
        <i class="ph-bold ph-arrow-left"></i> Voltar
      </a>
      
      <a href="admin.html" class="btn-admin" id="btn-admin">
        <i class="ph-bold ph-shield-check"></i> Admin
      </a>
    </div>

    <button class="btn-logout" id="btn-logout">
      <i class="ph-bold ph-sign-out"></i> Sair
    </button>
  </nav>

  <div class="profile-card">
    <div class="bg-gradient"></div>
    
    <div class="loading-overlay" id="loading-screen">
      <i class="ph ph-spinner spinner"></i>
    </div>

    <div class="profile-header">
      <div class="avatar-container">
        <img src="https://ui-avatars.com/api/?name=User&background=0f172a&color=fff" alt="Avatar" class="avatar" id="ui-foto">
        <button class="edit-btn" id="btn-open-edit"><i class="ph-bold ph-pencil-simple"></i></button>
      </div>
      
      <div style="margin-bottom: 4px;">
          <h2 class="user-name" style="display:inline;">
              <span id="ui-nome">Carregando...</span>
          </h2>
          <span class="badge-title" id="ui-badge">...</span>
      </div>

      <a href="#" target="_blank" class="instagram-link" id="ui-instagram-link" style="display: none;">
          <i class="ph-fill ph-instagram-logo"></i> <span id="ui-instagram-text">@usuario</span>
      </a>
      
      <p class="user-bio" id="ui-bio">...</p>
      
      <div class="member-since">
          <i class="ph ph-calendar-blank"></i> <span id="ui-member-since">Membro desde...</span>
      </div>

      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-value" id="ui-nivel">1</div>
          <div class="stat-label">Nível</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="ui-xp">0</div>
          <div class="stat-label">XP Total</div>
        </div>
      </div>

      <div class="xp-container">
        <div class="xp-info">
          <span>Progresso para próximo nível</span>
          <span id="ui-xp-next">0 / 100 XP</span>
        </div>
        <div class="progress-bg">
          <div class="progress-fill" id="ui-progress-bar"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="edit-modal">
    <div class="modal-box">
      <h3 class="modal-title">Editar Perfil</h3>

      <div class="input-group">
        <label>Nome de exibição</label>
        <input type="text" class="modal-input" id="edit-nome">
      </div>
      
      <div class="input-group">
        <label>Instagram (sem @)</label>
        <div style="position: relative;">
            <span style="position: absolute; left: 12px; top: 12px; color: var(--text-muted);">@</span>
            <input type="text" class="modal-input" id="edit-instagram" style="padding-left: 30px;">
        </div>
      </div>

      <div class="input-group">
        <label>Biografia</label>
        <input type="text" class="modal-input" id="edit-bio" maxlength="100" placeholder="Uma frase curta sobre você">
      </div>

      <div class="input-group">
        <label>URL da Foto de Perfil</label>
        <input type="text" class="modal-input" id="edit-foto-url" placeholder="https://linkdafoto.com/imagem.png">
      </div>

      <div class="modal-actions">
        <button class="btn-cancel" id="btn-close-modal">Cancelar</button>
        <button class="btn-save" id="btn-save-profile">Salvar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBEOpVc1EskZVgGkaegdKzA_WOk5C2qfO8",
        authDomain: "dursmsge0.firebaseapp.com",
        projectId: "dursmsge0",
        storageBucket: "dursmsge0.firebasestorage.app",
        messagingSenderId: "874076135664",
        appId: "1:874076135664:web:b04b0fa32c0a09948f2235"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ============================================
    // config do admin emails
    // ============================================
    const LISTA_ADMINS = [
        "gabrielmiller820@gmail.com", 
        "gabrielmiller1234567@gmail.com"
    ]; 

    let currentUserUid = null;
    let currentUserRef = null;

    const uiNome = document.getElementById('ui-nome');
    const uiBio = document.getElementById('ui-bio');
    const uiNivel = document.getElementById('ui-nivel');
    const uiXP = document.getElementById('ui-xp');
    const uiFoto = document.getElementById('ui-foto');
    const uiProgress = document.getElementById('ui-progress-bar');
    const uiXpNext = document.getElementById('ui-xp-next');
    const uiBadge = document.getElementById('ui-badge');
    const uiMemberSince = document.getElementById('ui-member-since');
    const uiInstaLink = document.getElementById('ui-instagram-link');
    const uiInstaText = document.getElementById('ui-instagram-text');
    const loadingScreen = document.getElementById('loading-screen');
    const btnAdmin = document.getElementById('btn-admin');

    const modal = document.getElementById('edit-modal');
    const editNome = document.getElementById('edit-nome');
    const editBio = document.getElementById('edit-bio');
    const editFotoUrl = document.getElementById('edit-foto-url');
    const editInstagram = document.getElementById('edit-instagram');

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUserUid = user.uid;
            currentUserRef = doc(db, "users", currentUserUid);
            
            if (LISTA_ADMINS.includes(user.email)) {
                btnAdmin.style.display = 'flex';
            } else {
                btnAdmin.style.display = 'none';
            }

            const creationDate = new Date(user.metadata.creationTime);
            uiMemberSince.innerText = `Membro desde ${creationDate.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' })}`;

            iniciarMonitoramento();
        } else {
            window.location.href = "login.html";
        }
    });

    function iniciarMonitoramento() {
        onSnapshot(currentUserRef, (docSnap) => {
            loadingScreen.style.display = 'none';
            if (docSnap.exists()) {
                atualizarTela(docSnap.data());
            } else {
                atualizarTela({ nome: "Novo Usuário", bio: "Bem-vindo!" });
            }
        });
    }

    function atualizarTela(data) {
        uiNome.innerText = data.nome || "Estudante";
        uiBio.innerText = data.bio || "Sem biografia.";

        const xpTotal = Number(data.xp) || 0;
        
        const nivelCalculado = Math.floor(xpTotal / 100) + 1;
        
        const xpNoNivelAtual = xpTotal % 100;
        const xpParaProximoNivel = 100;
        
        uiNivel.innerText = nivelCalculado;
        uiXP.innerText = xpTotal;

        let titulo = "Novato";
        if(nivelCalculado >= 5) titulo = "Explorador";
        if(nivelCalculado >= 10) titulo = "Veterano";
        if(nivelCalculado >= 20) titulo = "Mestre";
        if(nivelCalculado >= 50) titulo = "Lenda";
        uiBadge.innerText = titulo;

        uiFoto.src = (data.foto && data.foto.trim() !== "") ? data.foto : `https://ui-avatars.com/api/?name=${data.nome || 'User'}&background=05df34&color=001a05`;

        if (data.instagram && data.instagram.trim() !== "") {
            uiInstaLink.style.display = "inline-flex";
            uiInstaLink.href = `https://instagram.com/${data.instagram.replace('@', '')}`;
            uiInstaText.innerText = "@" + data.instagram.replace('@', '');
        } else {
            uiInstaLink.style.display = "none";
        }

        let percentage = (xpNoNivelAtual / xpParaProximoNivel) * 100;
        uiProgress.style.width = `${percentage}%`;
        uiXpNext.innerText = `${xpNoNivelAtual} / ${xpParaProximoNivel} XP`;
    }

    document.getElementById('btn-logout').addEventListener('click', () => {
        if(confirm("Sair da conta?")) signOut(auth).then(() => window.location.href = "login.html");
    });

    document.getElementById('btn-open-edit').addEventListener('click', () => {
        editNome.value = uiNome.innerText;
        editBio.value = uiBio.innerText === "Sem biografia." ? "" : uiBio.innerText;
        editFotoUrl.value = uiFoto.src.includes('ui-avatars') ? "" : uiFoto.src;
        editInstagram.value = uiInstaText.innerText === "@usuario" ? "" : uiInstaText.innerText.replace('@','');
        modal.classList.add('open');
    });

    document.getElementById('btn-close-modal').addEventListener('click', () => modal.classList.remove('open'));

    document.getElementById('btn-save-profile').addEventListener('click', async () => {
        if(!editNome.value) return alert("O nome não pode ficar vazio.");
        
        const btn = document.getElementById('btn-save-profile');
        btn.innerText = "Salvando...";
        btn.disabled = true;

        try {
            await setDoc(currentUserRef, {
                nome: editNome.value,
                bio: editBio.value,
                instagram: editInstagram.value,
                foto: editFotoUrl.value
            }, { merge: true });
            modal.classList.remove('open');
        } catch (e) {
            alert("Erro ao salvar.");
        } finally {
            btn.innerText = "Salvar";
            btn.disabled = false;
        }
    });
  </script>
</body>
</html>
