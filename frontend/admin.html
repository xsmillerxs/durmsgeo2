<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Alian√ßa Drenante IFRN</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4338ca;
            --bg-body: #0f172a;
            --bg-panel: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --border: rgba(255,255,255,0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .sidebar {
            width: 260px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: fixed;
            height: 100%;
            z-index: 10;
        }
        .brand {
            font-size: 1.5rem;
            font-weight: 800;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 40px;
            padding-left: 10px;
        }
        .nav-links { list-style: none; }
        .nav-link {
            display: flex; align-items: center; gap: 12px; padding: 12px 15px;
            text-decoration: none; color: var(--text-muted); border-radius: 8px;
            transition: 0.2s; font-size: 0.95rem; font-weight: 500; margin-bottom: 5px;
        }
        .nav-link:hover, .nav-link.active { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .nav-link.danger:hover { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 30px;
            width: calc(100% - 260px);
        }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .admin-info-badge {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--bg-panel);
            padding: 10px 20px;
            border-radius: 50px;
            border: 1px solid var(--border);
            font-size: 0.85rem;
        }
        .info-item { display: flex; align-items: center; gap: 8px; color: var(--text-muted); }
        .info-item strong { color: var(--primary); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-panel); border: 1px solid var(--border); padding: 20px; border-radius: 12px; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary); }
        .stat-value { font-size: 2rem; font-weight: 700; margin-top: 8px; color: #fff; }
        .stat-label { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; font-weight: 600; }
        .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        @media (max-width: 768px) { .actions-grid { grid-template-columns: 1fr; } }
        .control-card {
            background: var(--bg-panel); border: 1px solid var(--border);
            padding: 20px; border-radius: 12px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .control-card.warning { border-color: rgba(245, 158, 11, 0.3); background: rgba(245, 158, 11, 0.05); }
        .control-card.danger { 
            border-color: rgba(239, 68, 68, 0.3); 
            background: rgba(239, 68, 68, 0.05); 
            flex-direction: column; 
            align-items: flex-start;
            gap: 15px;
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--warning); }
        input:checked + .slider:before { transform: translateX(24px); }
        .card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 25px; margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 10px; color: var(--text-muted); border-bottom: 1px solid var(--border); font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 16px 10px; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 0.85rem;}
        .btn-danger-outline { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-warning-outline { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid var(--warning); }
        .btn-danger-solid { background: var(--danger); color: white; width: 100%; padding: 10px; }
        .btn-warning-solid { background: var(--warning); color: white; width: 100%; padding: 10px; }
        .action-buttons { display: flex; gap: 8px; }
        .reset-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; }
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .mic-btn {
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            transition: 0.3s;
        }
        .mic-btn.active {
            background: var(--danger);
            box-shadow: 0 0 15px var(--danger);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div id="auth-overlay">
        <i class="fas fa-circle-notch fa-spin fa-3x" style="color: var(--primary); margin-bottom: 20px;"></i>
        <h2>Autenticando...</h2>
    </div>
    <nav class="sidebar">
        <div class="brand"><i class="fas fa-globe-americas" style="color: var(--primary);"></i> Alian√ßa</div>
        <ul class="nav-links">
            <li><a href="#" class="nav-link active"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
            <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> Voltar ao Site</a></li>
            <li style="margin-top: auto;"><a href="#" onclick="fazerLogout()" class="nav-link danger"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
        </ul>
    </nav>
    <main class="main-content">
        <div class="top-bar">
            <div>
                <h2 style="font-weight:600;">Painel Administrativo</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem;">IFRN - Controle Geral</p>
            </div>
            <div class="admin-info-badge">
                <div class="info-item"><i class="fas fa-user-shield"></i> <span id="display-email">carregando...</span></div>
                <div class="info-item"><i class="fas fa-network-wired"></i> IP: <strong id="display-ip">0.0.0.0</strong></div>
                <button class="mic-btn" id="start-record" title="Comando de Voz"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
        <div class="actions-grid">
            <div class="control-card warning">
                <div>
                    <h4 style="color: var(--warning); display: flex; align-items: center; gap: 8px;"><i class="fas fa-tools"></i> MODO MANUTEN√á√ÉO</h4>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">Bloqueia acesso dos alunos.</p>
                </div>
                <label class="switch"><input type="checkbox" id="maintenance-toggle"><span class="slider"></span></label>
            </div>
            <div class="control-card danger">
                <div style="width: 100%; margin-bottom: 10px;">
                    <h4 style="color: var(--danger); display: flex; align-items: center; gap: 8px;"><i class="fas fa-skull"></i> ZONA DE PERIGO</h4>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">A√ß√µes globais irrevers√≠veis.</p>
                </div>
                <div class="reset-grid">
                    <button id="btn-reset-level" class="btn btn-warning-solid">Zerar N√≠vel</button>
                    <button id="btn-reset-xp-only" class="btn btn-warning-solid">Zerar XP</button>
                    <button id="btn-reset-all" class="btn btn-danger-solid">Zerar TUDO</button>
                </div>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">Total de Alunos</div><div class="stat-value" id="stat-total-users">0</div></div>
            <div class="stat-card"><div class="stat-label">XP Acumulado</div><div class="stat-value" id="stat-total-xp" style="color: var(--success);">0</div></div>
            <div class="stat-card"><div class="stat-label">Status</div><div class="stat-value" style="color: var(--success); font-size: 1.2rem; margin-top: 15px;">Online üü¢</div></div>
        </div>
        <div class="card">
            <div class="card-header"><h3>Lista de Alunos</h3></div>
            <div style="overflow-x: auto;">
                <table id="users-table">
                    <thead><tr><th>Aluno</th><th>Email</th><th>N√≠vel / XP</th><th>A√ß√µes</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </main>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, updateDoc, onSnapshot, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyBEOpVc1EskZVgGkaegdKzA_WOk5C2qfO8",
            authDomain: "dursmsge0.firebaseapp.com",
            projectId: "dursmsge0",
            storageBucket: "dursmsge0.firebasestorage.app",
            messagingSenderId: "874076135664",
            appId: "1:874076135664:web:b04b0fa32c0a09948f2235"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const ADMIN_EMAILS = ['gabrielmiller820@gmail.com', 'admin@durmsgeo.com'];
        const COLLECTION_USERS = "users"; 
        const DOC_CONFIG = doc(db, "config", "geral");
        async function obterIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                document.getElementById('display-ip').innerText = data.ip;
            } catch (e) {
                document.getElementById('display-ip').innerText = "Indispon√≠vel";
            }
        }
        function iniciarVoz() {
            const btn = document.getElementById('start-record');
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'pt-BR';
            btn.onclick = () => {
                recognition.start();
                btn.classList.add('active');
            };
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                btn.classList.remove('active');
                if(transcript.includes("limpar") || transcript.includes("zerar")) {
                    alert("Comando de voz recebido: " + transcript);
                }
            };
            recognition.onend = () => btn.classList.remove('active');
        }
        function verificarAcesso() {
            const currentUserRaw = localStorage.getItem('user_data');
            if (!currentUserRaw) {
                window.location.href = 'login.html';
                return;
            }
            const currentUser = JSON.parse(currentUserRaw);
            if (!ADMIN_EMAILS.includes(currentUser.email.toLowerCase())) {
                window.location.href = 'index.html';
            } else {
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('display-email').innerText = currentUser.email;
                obterIP();
                iniciarVoz();
                iniciarMonitoramentoUsers();
                iniciarMonitoramentoManutencao();
                configurarBotoesReset();
            }
        }
        function iniciarMonitoramentoManutencao() {
            const toggle = document.getElementById('maintenance-toggle');
            onSnapshot(DOC_CONFIG, (docSnap) => {
                if (docSnap.exists()) toggle.checked = docSnap.data().manutencao === true;
            });
            toggle.onchange = async (e) => {
                await setDoc(DOC_CONFIG, { manutencao: e.target.checked }, { merge: true });
            };
        }
        function iniciarMonitoramentoUsers() {
            const q = query(collection(db, COLLECTION_USERS), orderBy("xp", "desc"));
            onSnapshot(q, (snapshot) => {
                const users = [];
                let totalXp = 0;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    users.push({ id: doc.id, ...data });
                    totalXp += (parseInt(data.xp) || 0);
                });
                atualizarTela(users, totalXp);
            });
        }
        function atualizarTela(users, totalXp) {
            document.getElementById('stat-total-users').innerText = users.length;
            document.getElementById('stat-total-xp').innerText = totalXp;
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '';
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.nome || 'Sem Nome'}</td>
                    <td>${user.email}</td>
                    <td>${user.xp || 0} XP (Lvl ${user.nivel || 0})</td>
                    <td>
                        <button class="btn btn-warning-outline" onclick="resetUser('${user.id}')">Reset</button>
                        <button class="btn btn-danger-outline" onclick="deleteUser('${user.id}')">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        async function executarMassUpdate(dados, nome, btn) {
            const original = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = "Processando...";
            const snap = await getDocs(collection(db, COLLECTION_USERS));
            const batch = writeBatch(db);
            snap.forEach(d => batch.update(d.ref, dados));
            await batch.commit();
            alert(nome + " finalizado.");
            btn.disabled = false;
            btn.innerHTML = original;
        }
        function configurarBotoesReset() {
            document.getElementById('btn-reset-level').onclick = function() { executarMassUpdate({nivel: 0}, "Reset de N√≠veis", this); };
            document.getElementById('btn-reset-xp-only').onclick = function() { executarMassUpdate({xp: 0}, "Reset de XP", this); };
            document.getElementById('btn-reset-all').onclick = function() { executarMassUpdate({xp: 0, nivel: 0}, "Reset Geral", this); };
        }
        window.deleteUser = async (id) => { if(confirm("Excluir?")) await deleteDoc(doc(db, COLLECTION_USERS, id)); };
        window.resetUser = async (id) => { if(confirm("Zerar?")) await updateDoc(doc(db, COLLECTION_USERS, id), {xp: 0, nivel: 0}); };
        window.fazerLogout = () => { localStorage.removeItem('user_data'); window.location.href = 'index.html'; };
        verificarAcesso();
    </script>
</body>
</html>