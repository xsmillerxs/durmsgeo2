<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz - Durmsgeo IFRN</title>
  
  <meta name="description" content="Teste seus conhecimentos sobre drenagem urbana e alagamentos." />
  <meta name="author" content="IFRN - Durmsgeo" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="css/style.css">

  <style>
    /* ======================
       1. CSS GERAL E DESIGN
       ====================== */

    :root {
      --primary: #05df34;       
      --primary-dark: #004d40;
      --accent: #FFC107;        

      --bg-body: #0e0d0d;
      --bg-section-alt: #1a1a1a;
      --bg-card: #0e0d0d;
      --text-main: #148d2f;      
      --text-muted: #05df34;     
      --nav-bg: rgba(255, 255, 255, 0.85);
      --nav-border: rgba(0,0,0,0.05);
      --card-border: rgba(255, 255, 255, 0.1);

      --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
      --radius: 16px;
    }

    [data-theme="dark"] {
      --bg-body: #0f172a;       
      --bg-section-alt: #1e293b; 
      --bg-card: #1e293b;        
      --text-main: #f1f5f9;      
      --text-muted: #94a3b8;     
      --nav-bg: rgba(15, 17, 42, 0.85);
      --nav-border: rgba(255,255,255,0.1);
      --card-border: rgba(255,255,255,0.05);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-body);
      color: #fff;
      line-height: 1.6;
      overflow-x: hidden;
    }

    h2, h3 { color: var(--text-main); }
    p { color: #ccc; }

    /* --- NAV BAR --- */
    .site-nav {
      position: sticky; top: 20px; margin: 0 auto; width: 90%; max-width: 1000px;
      background: var(--nav-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      padding: 15px 30px; border-radius: 50px; display: flex; justify-content: center;
      gap: 25px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); z-index: 1000; flex-wrap: wrap;
      border: 1px solid var(--nav-border);
    }

    .site-nav a {
      text-decoration: none; color: #000; font-weight: 600; font-size: 0.95rem;
      transition: color 0.3s ease; position: relative;
    }

    [data-theme="dark"] .site-nav a { color: #fff; }
    .site-nav a:hover { color: var(--primary); }

    .site-nav a::after {
      content: ''; position: absolute; width: 0; height: 2px; bottom: -4px; left: 0;
      background-color: var(--accent); transition: width 0.3s;
    }
    .site-nav a:hover::after { width: 100%; }

    /* --- HERO --- */
    .hero-outer {
      background: radial-gradient(circle at top right, #00695c, #004d40);
      color: white; padding-top: 40px; padding-bottom: 80px; position: relative;
      overflow: hidden; border-bottom-left-radius: 60px; border-bottom-right-radius: 60px;
      border-bottom: 4px solid var(--accent);
    }

    .blob {
      position: absolute; background: rgba(255, 255, 255, 0.05); border-radius: 50%;
      animation: float 20s infinite ease-in-out; z-index: 0;
    }
    .blob-1 { width: 400px; height: 400px; top: -100px; left: -100px; }
    .blob-2 { width: 300px; height: 300px; bottom: -50px; right: -50px; animation-delay: -5s; }

    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(30px, 40px); }
    }

    .hero {
      display: flex; align-items: center; justify-content: space-between; max-width: 1200px;
      margin: 0 auto; padding: 40px 20px; position: relative; z-index: 1; gap: 40px; flex-wrap: wrap;
    }

    .hero-content { flex: 1; min-width: 300px; }

    .brand-logos { display: flex; gap: 20px; margin-bottom: 30px; align-items: center; }
    .brand-logos img { height: 60px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }

    .hero-title {
      font-size: 3rem; font-weight: 900; line-height: 1.1; margin-bottom: 15px;
      background: linear-gradient(to right, #ffffff, #FFC107);
      background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; color: transparent;
    }

    .hero-sub { font-size: 1.2rem; color: rgba(255,255,255,0.9); margin-bottom: 40px; max-width: 520px; }

    .hero-visual { flex: 1; display: flex; justify-content: center; }
    .hero-visual img { max-width: 100%; height: auto; animation: gentle-float 6s ease-in-out infinite; }
    @keyframes gentle-float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }

    /* ======================
       2. CSS ESPEC√çFICO DO QUIZ
       ====================== */

    .quiz-wrapper { max-width: 900px; margin: 0 auto; }

    .quiz-card {
      background: var(--bg-card); border-radius: 24px; padding: 35px;
      box-shadow: var(--shadow-card); border: 1px solid var(--card-border);
      margin-top: 20px; position: relative; overflow: hidden; min-height: 400px;
    }

    .quiz-header { display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 20px; }
    .quiz-title { font-size: 1.4rem; font-weight: 800; color: var(--text-main); }
    .quiz-counter { font-size: 0.9rem; color: #aaa; font-weight: 600; }

    .quiz-progress { width: 100%; height: 10px; background: rgba(255,255,255,0.08); border-radius: 999px; overflow: hidden; margin-bottom: 30px; }
    .quiz-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.4s ease; border-radius: 999px; }

    .quiz-question { font-size: 1.5rem; font-weight: 800; margin-bottom: 25px; line-height: 1.3; color: #fff; }

    .quiz-options { display: grid; gap: 14px; }

    .quiz-option {
      background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.08);
      padding: 16px 20px; border-radius: 14px; cursor: pointer; font-size: 1rem;
      font-weight: 600; color: #eee; text-align: left; transition: all 0.25s ease;
    }
    .quiz-option:hover:not(:disabled) { transform: translateY(-2px); border-color: var(--primary); background: rgba(5, 223, 52, 0.08); }

    .quiz-option.correct { background: linear-gradient(135deg, #27ae60, #2ecc71); color: #fff; border-color: #2ecc71; box-shadow: 0 10px 25px rgba(46, 204, 113, 0.25); }
    .quiz-option.wrong { background: linear-gradient(135deg, #e74c3c, #ff6b6b); color: #fff; border-color: #ff7675; box-shadow: 0 10px 25px rgba(231, 76, 60, 0.25); opacity: 0.7; }

    .quiz-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; gap: 15px; flex-wrap: wrap; }
    .quiz-score { font-weight: 700; color: var(--primary); }

    .quiz-btn {
      padding: 12px 22px; border-radius: 999px; font-weight: 700; border: none;
      cursor: pointer; background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #004d40; transition: transform 0.2s, box-shadow 0.2s; text-decoration: none; display: inline-block;
    }
    .quiz-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    .quiz-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; filter: grayscale(1); }

    /* ESTADOS DE VISUALIZA√á√ÉO (LOADING, BLOQUEADO, LOGIN) */
    .view-state { text-align: center; display: none; padding: 40px 20px; }
    .view-state h3 { font-size: 1.8rem; margin-bottom: 15px; color: var(--text-main); }
    .view-state p { margin-bottom: 25px; font-size: 1.1rem; color: #ccc; }
    
    .loading-spinner {
        border: 4px solid rgba(255,255,255,0.1);
        border-left-color: var(--primary);
        border-radius: 50%;
        width: 40px; height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* RESULTADOS */
    .quiz-results { text-align: center; display: none; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .quiz-results h3 { font-size: 2rem; font-weight: 900; margin-bottom: 10px; }
    .quiz-final-score { font-size: 3.2rem; font-weight: 900; color: var(--primary); margin: 15px 0; }
    .action-box { margin-top: 30px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
    
    .status-msg { font-size: 0.85rem; padding: 8px 15px; border-radius: 8px; display: inline-block; margin-bottom: 15px; }
    .status-success { color: #2ecc71; background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.3); }
    .status-error { color: #e74c3c; background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.3); }

    /* User Welcome */
    .user-welcome {
        font-size: 0.9rem;
        color: var(--accent);
        font-weight: 600;
        margin-bottom: 10px;
    }

    /* Responsivo */
    @media (max-width: 768px) {
      .hero-title { font-size: 2.2rem; }
      .hero { flex-direction: column-reverse; text-align: center; }
      .brand-logos { justify-content: center; }
      .site-nav { display: none; }
      .quiz-question { font-size: 1.25rem; }
    }
  </style>
</head>

<body>

  <canvas id="snow"></canvas>
  <div class="cursor-personalizado"></div>

  <header class="hero-outer">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <nav class="site-nav" role="navigation">
      <a href="index.html">In√≠cio</a>
      <a href="quem-somos.html">Quem Somos</a>
      <a href="entenda-problema.html">Problemas</a>
      <a href="educacao.html">Educa√ß√£o</a> 
      <a href="solucao.html">Solu√ß√µes</a>
      <a href="mapa-risco.html">Mapa</a>
      <a href="quiz.html" style="color:var(--primary); font-weight:700;">Quiz</a>
    </nav>

    <div class="hero">
      <div class="hero-content">
        <div class="brand-logos">
        <img src="assets/logo2.png" alt="Logo Lateral">
        <img src="assets/image.png" alt="Logo Principal">
        <img src="assets/alian√ßa.jpg" alt="Logo Lateral">
        <img src="assets/if.png" alt="Logo Lateral">
        </div>

        <h1 class="hero-title">Quiz Educativo</h1>
        <p class="hero-sub">Teste seus conhecimentos sobre drenagem urbana. <br>Ganhe XP para seu perfil!</p>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
           <a href="#quiz" class="btn" style="background:var(--accent); color:#004d40; padding:12px 24px; border-radius:50px; text-decoration:none; font-weight:700;">Ir para o Quiz</a>
           <button id="themeToggle" class="btn" style="background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.3); padding:12px 15px; border-radius:50px; cursor:pointer;" title="Alternar tema">üåô</button>
        </div>
      </div>

      <div class="hero-visual">
        <img src="assets/logo.png" alt="Ilustra√ß√£o Durmsgeo">
      </div>
    </div>
  </header>

  <main id="content">

    <section id="quiz" class="section reveal">
      <div class="container quiz-wrapper">

        <div class="quiz-card" id="quiz-card">
          
          <div id="view-loading" class="view-state" style="display: block;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 15px;">Verificando usu√°rio...</p>
          </div>

          <div id="view-visitor" class="view-state">
            <h3>Acesso Restrito üîí</h3>
            <p>Voc√™ est√° acessando como Visitante.</p>
            <p style="font-size: 0.95rem; opacity: 0.8;">Para realizar o quiz e ganhar XP no ranking, voc√™ precisa estar logado na sua conta.</p>
            <a href="login.html" class="quiz-btn">Fazer Login / Criar Conta</a>
          </div>

          <div id="view-blocked" class="view-state">
            <h3>Quiz Conclu√≠do ‚úÖ</h3>
            <p>Voc√™ j√° realizou este quiz anteriormente.</p>
            <p style="font-size: 0.95rem; opacity: 0.8; max-width: 500px; margin: 0 auto 20px auto;">Para garantir a integridade do Ranking, o quiz s√≥ pode ser respondido uma √∫nica vez por conta.</p>
            <a href="ranking.html" class="quiz-btn" style="background: var(--accent); color: #000;">Ver Ranking</a>
            <a href="perfil.html" class="quiz-btn" style="background: rgba(255,255,255,0.1); color: #fff;">Meu Perfil</a>
          </div>

          <div id="quiz-active-container" style="display: none;">
            <div class="quiz-header">
              <div>
                  <div class="user-welcome" id="user-welcome-msg"></div>
                  <div class="quiz-title">Quiz Educativo</div>
              </div>
              <div class="quiz-counter" id="quiz-counter">Quest√£o 1 de 10</div>
            </div>

            <div class="quiz-progress">
              <div class="quiz-progress-fill" id="quiz-progress-fill"></div>
            </div>

            <div class="quiz-question" id="quiz-question">
              Carregando pergunta...
            </div>

            <div class="quiz-options" id="quiz-options"></div>

            <div class="quiz-footer">
              <div class="quiz-score" id="quiz-score">Pontua√ß√£o: 0</div>
              <button class="quiz-btn" id="next-btn" disabled>Pr√≥xima</button>
            </div>
          </div>

          <div class="quiz-results" id="quiz-results">
            <h3>Parab√©ns! üéâ</h3>
            <p>Voc√™ concluiu o quiz.</p>
            <div class="quiz-final-score" id="final-score">0 / 10</div>
            
            <div class="xp-gain" id="xp-gain-display" style="color: #FFC107; font-weight: 800; font-size: 1.2rem; margin-bottom: 5px;">
              +0 XP
            </div>

            <div id="save-status-msg" class="status-msg" style="display:none;">Salvando dados...</div>

            <div class="action-box">
                <button onclick="shareWhatsApp()" class="quiz-btn" style="background: #25D366; color: #fff; display:flex; align-items:center; justify-content:center; gap:8px; width: 100%; max-width: 300px;">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.711 2.598 2.669-.698c1.009.554 1.939.846 3.075.846 3.183 0 5.768-2.586 5.768-5.766.001-3.18-2.585-5.766-5.766-5.766zm-9.412 17.828l-2.619-9.577c-2.435-8.908 6.787-14.424 13.799-14.424 5.259 0 9.725 3.196 11.236 8.016 1.636 5.216-1.528 10.957-6.524 12.396-1.922.553-5.239.529-7.399-.187-1.161.854-3.535 2.555-4.469 3.138-.85.531-2.071.785-2.071.785s.434-1.297.77-2.739c-.495-.456-2.072-2.316-2.723-4.408zm16.382-7.828c-.347-.173-2.053-1.007-2.372-1.121-.318-.115-.55-.174-.78.173-.231.348-.897 1.123-1.099 1.353-.203.232-.405.261-.752.088-1.545-.772-2.56-1.393-3.585-3.15-.268-.459.268-.426.769-1.425.088-.173.044-.323-.022-.456-.066-.134-.579-1.394-.793-1.908-.208-.499-.42-.431-.579-.439-.148-.007-.318-.008-.491-.008-.174 0-.455.065-.694.324-.239.261-.911.89-1.911 2.174s1.206 2.082 1.374 2.338c.168.256 2.767 4.195 6.711 5.882 2.659 1.137 3.199.91 3.754.853.615-.063 2.053-.836 2.342-1.644.29-.808.29-1.5.203-1.644-.087-.145-.319-.232-.666-.406z"/></svg>
                    Compartilhar no WhatsApp
                </button>
                
                <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                    <a href="perfil.html" class="quiz-btn" style="background: var(--primary); color: #000; text-decoration:none;">Ver Meu Perfil</a>
                    <a href="ranking.html" class="quiz-btn" style="background: var(--accent); color: #004d40; text-decoration:none;">Ver Ranking</a>
                </div>
            </div>
          </div>

        </div>

      </div>
    </section>

  </main>

  <footer class="footer">
    <div class="container">
      <p>¬© 2025 IFRN - Durmsgeo ¬∑ <strong>Projeto Alian√ßa Drenante</strong></p>
      <p style="font-size: 0.8rem; margin-top: 5px; opacity: 0.6;">Desenvolvido com prop√≥sitos educacionais.</p>
    </div>
  </footer>

  <script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBEOpVc1EskZVgGkaegdKzA_WOk5C2qfO8",
        authDomain: "dursmsge0.firebaseapp.com",
        projectId: "dursmsge0",
        storageBucket: "dursmsge0.firebasestorage.app",
        messagingSenderId: "874076135664",
        appId: "1:874076135664:web:b04b0fa32c0a09948f2235"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const XP_PER_QUESTION = 10; 

    // Perguntas
    const questions = [
      { question: "1. O que √© intemperismo?", options: ["Altera√ß√£o mec√¢nica.", "Eros√£o pluvial.", "Desgaste de rochas e solos por fatores f√≠sicos/qu√≠micos.", "Modifica√ß√£o humana."], correct: 2 },
      { question: "2. Quais s√£o os principais tipos de intemperismo?", options: ["F√≠sico, qu√≠mico e biol√≥gico.", "Atmosf√©rico e pluvial.", "Lixivia√ß√£o e eros√£o.", "Mec√¢nico e profundo."], correct: 0 },
      { question: "3. Como a impermeabiliza√ß√£o contribui para alagamentos?", options: ["Evita escoamento.", "Impede lixivia√ß√£o.", "Permite infiltra√ß√£o.", "Reduz infiltra√ß√£o natural e sobrecarrega bueiros."], correct: 3 },
      { question: "4. O que √© lixivia√ß√£o do solo?", options: ["Compacta√ß√£o.", "Transporte de nutrientes pela √°gua.", "Ac√∫mulo de √°gua.", "Crescimento de plantas."], correct: 1 },
      { question: "5. Solo lixiviado contribui para alagamentos porque...", options: ["Fica fr√°gil e absorve menos √°gua.", "Aumenta asfalto.", "Acelera infiltra√ß√£o.", "Bloqueia drenagem."], correct: 0 },
      { question: "6. O que acelera o intemperismo no Loteamento Alian√ßa?", options: ["√Åreas verdes.", "Planejamento.", "Ocupa√ß√£o irregular e lixo.", "Conten√ß√£o de solo."], correct: 2 },
      { question: "7. Qual a rela√ß√£o da lagoa Jardim Primavera com o Alian√ßa?", options: ["N√£o transborda.", "Entupimentos fazem-na transbordar para o Alian√ßa.", "Absorve tudo.", "N√£o tem efeito."], correct: 1 },
      { question: "8. Solu√ß√£o para reduzir impactos de impermeabiliza√ß√£o:", options: ["Mais asfalto.", "Substituir solo por areia.", "Lagoas sem manuten√ß√£o.", "Plantio de √°reas verdes e conscientiza√ß√£o."], correct: 3 },
      { question: "9. Por que o Alian√ßa √© vulner√°vel?", options: ["Urbaniza√ß√£o desordenada e solo fr√°gil.", "Planejamento avan√ßado.", "Escassez de chuvas.", "Muitos canais verdes."], correct: 0 },
      { question: "10. Como os processos se conectam?", options: ["Eles fortalecem o solo.", "N√£o se influenciam.", "Intemperismo desgasta, lixivia√ß√£o empobrece e impermeabiliza√ß√£o alaga.", "Apenas o asfalto importa."], correct: 2 }
    ];

    // Views (Telas)
    const vLoading = document.getElementById("view-loading");
    const vVisitor = document.getElementById("view-visitor");
    const vBlocked = document.getElementById("view-blocked");
    const vActive  = document.getElementById("quiz-active-container");
    const vResults = document.getElementById("quiz-results");

    // Elementos de Controle
    const elCounter = document.getElementById("quiz-counter");
    const elQuestion = document.getElementById("quiz-question");
    const elOptions = document.getElementById("quiz-options");
    const elScoreLive = document.getElementById("quiz-score");
    const elNextBtn = document.getElementById("next-btn");
    const elProgress = document.getElementById("quiz-progress-fill");
    const elWelcomeMsg = document.getElementById("user-welcome-msg");

    let currentQuestion = 0;
    let score = 0;
    let answered = false;
    let currentUserUid = null;

    // --- L√ìGICA DE AUTENTICA√á√ÉO E INICIALIZA√á√ÉO ---

    onAuthStateChanged(auth, async (user) => {
        // Reseta todas as views
        vLoading.style.display = "none";
        vVisitor.style.display = "none";
        vBlocked.style.display = "none";
        vActive.style.display = "none";
        vResults.style.display = "none";

        if (user) {
            // USU√ÅRIO LOGADO
            currentUserUid = user.uid;
            console.log("Usu√°rio autenticado:", currentUserUid);

            // Verificar se j√° fez o quiz no banco de dados
            try {
                const userRef = doc(db, "users", currentUserUid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    
                    // Exibe nome do usu√°rio
                    elWelcomeMsg.textContent = `Jogando como: ${userData.nome || user.email}`;

                    // VERIFICA√á√ÉO CR√çTICA: J√° fez o quiz?
                    if (userData.quizDone === true) {
                        vBlocked.style.display = "block"; // Bloqueia
                    } else {
                        vActive.style.display = "block"; // Libera
                        loadQuestion(); // Carrega primeira pergunta
                    }
                } else {
                    // Documento n√£o existe (raro se o cadastro for feito corretamente), mas libera o quiz
                    vActive.style.display = "block";
                    loadQuestion();
                }

            } catch (error) {
                console.error("Erro ao verificar status do quiz:", error);
                alert("Erro de conex√£o. Recarregue a p√°gina.");
            }

        } else {
            // USU√ÅRIO N√ÉO LOGADO (VISITANTE)
            console.log("Nenhum usu√°rio logado.");
            vVisitor.style.display = "block";
        }
    });

    // --- L√ìGICA DO QUIZ ---

    function loadQuestion() {
      answered = false;
      elNextBtn.disabled = true;
      elNextBtn.textContent = (currentQuestion === questions.length - 1) ? "Finalizar Quiz" : "Pr√≥xima";

      const q = questions[currentQuestion];
      elCounter.textContent = `Quest√£o ${currentQuestion + 1} de ${questions.length}`;
      elQuestion.textContent = q.question;
      elOptions.innerHTML = "";

      const percent = (currentQuestion / questions.length) * 100;
      elProgress.style.width = percent + "%";

      q.options.forEach((opt, index) => {
        const btn = document.createElement("button");
        btn.className = "quiz-option";
        btn.textContent = opt;
        btn.onclick = () => selectAnswer(btn, index);
        elOptions.appendChild(btn);
      });
    }

    function selectAnswer(button, index) {
      if (answered) return;
      answered = true;

      const q = questions[currentQuestion];
      const allOptions = document.querySelectorAll(".quiz-option");

      allOptions.forEach(btn => btn.disabled = true);

      if (index === q.correct) {
        button.classList.add("correct");
        score++;
      } else {
        button.classList.add("wrong");
        allOptions[q.correct].classList.add("correct");
      }

      elScoreLive.textContent = `Pontua√ß√£o: ${score}`;
      elNextBtn.disabled = false;
    }

    elNextBtn.addEventListener("click", () => {
      currentQuestion++;
      if (currentQuestion < questions.length) {
        loadQuestion();
      } else {
        showResults();
      }
    });

    function showResults() {
      vActive.style.display = "none";
      vResults.style.display = "block";
      elProgress.style.width = "100%";

      document.getElementById("final-score").textContent = `${score} / ${questions.length}`;
      const xpGained = score * XP_PER_QUESTION;
      document.getElementById("xp-gain-display").textContent = `+${xpGained} XP`;

      saveScoreToFirebase(xpGained);
    }

    // --- SALVAMENTO NO FIREBASE (USANDO UID) ---

    async function saveScoreToFirebase(xpGained) {
      if (!currentUserUid) return;

      const statusEl = document.getElementById("save-status-msg");
      statusEl.style.display = "inline-block";
      statusEl.textContent = "Salvando XP no perfil...";
      statusEl.className = "status-msg"; 

      try {
        const userRef = doc(db, "users", currentUserUid);
        
        // Atualiza XP e MARCA O QUIZ COMO FEITO (quizDone: true)
        await updateDoc(userRef, {
            xp: increment(xpGained),
            quizDone: true
        });

        statusEl.textContent = "‚úÖ XP salvo e Quiz conclu√≠do!";
        statusEl.classList.add("status-success");

      } catch (e) {
        console.error("Erro ao salvar:", e);
        statusEl.textContent = "‚ö†Ô∏è Erro ao salvar online.";
        statusEl.classList.add("status-error");
      }
    }

    window.shareWhatsApp = function() {
      const xpGained = score * XP_PER_QUESTION;
      const text = `üß† Acabei de fazer o Quiz Durmsgeo!\n\n‚úÖ Acertei: ${score}/${questions.length}\n‚ú® Ganhei: ${xpGained} XP\n\nVoc√™ consegue superar minha pontua√ß√£o?`;
      window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`, '_blank');
    }
  </script>
  
  <script src="js/script.js" defer></script>
  <script src="js/player-musica.js" defer></script>

</body>
</html>